<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NLABS — DNA Generator 9.5 (Base Sepolia) — Patch C</title>
<style>
  :root{ --win-bg:#008080; --win-panel:#c0c0c0; --win-blue:#000080; }
  html,body{margin:0;padding:0}
  body{background:var(--win-bg);font-family:'MS Sans Serif',Tahoma,Arial,sans-serif;display:flex;justify-content:center;min-height:100vh}
  .desktop{width:min(900px,98vw);margin:14px}
  .window{background:var(--win-panel);border:2px solid #fff;box-shadow:2px 2px 0 #000}
  .title-bar{background:var(--win-blue);color:#fff;font-weight:bold;padding:4px 8px;display:flex;align-items:center;justify-content:space-between}
  .title-right{display:flex;gap:6px}
  .title-btn{width:16px;height:16px;background:#c0c0c0;color:#000;border:1px solid #fff;text-align:center;line-height:14px;font-size:12px}
  .content{background:#fff;border:2px inset #c0c0c0;padding:10px}
  .tabs{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
  .tab{padding:4px 10px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;font-size:14px}
  .tab.active{border:2px inset #fff;background:#ddd}
  .pane{display:none}
  .pane.active{display:block}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
  select,input[type=text]{background:#fff;border:2px inset #fff;padding:4px;font-size:14px}
  select{min-width:210px}
  input[type=text]{width:110px}
  button{padding:4px 10px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;font-size:14px}
  button:active{border:2px inset #fff}
  button:disabled{color:#777;cursor:not-allowed;border:2px inset #fff}
  input[type=range]{min-width:140px}
  .hint{font-size:12px;color:#000080;margin:6px 0}
  .badge{font-size:12px;background:#ececec;border:1px solid #999;padding:2px 6px}
  canvas{display:block;border:2px solid #000;background:#eee;margin:8px 0;max-width:100%;height:auto}
  .status{font-size:12px;margin-top:4px;word-break:break-all}
  .coming{padding:18px;background:#efefef;border:2px inset #c0c0c0}
  .footer{font-size:11px;color:#222;margin-top:6px;opacity:.9}
  @media (max-width:560px){
    .row > *{flex:1 1 auto}
    select{min-width:unset}
  }
</style>
</head>
<body>
<div class="desktop">
  <div class="window">
    <div class="title-bar">
      <div>NLABS — DNA Suite</div>
      <div class="title-right">
        <button id="connectBtn" class="title-btn" title="Connect">◎</button>
        <div class="title-btn">□</div>
        <div class="title-btn">X</div>
      </div>
    </div>
    <div class="content">
      <div class="tabs">
        <div class="tab active" data-pane="mint">Mint</div>
        <div class="tab" data-pane="gallery">Gallery</div>
        <div class="tab" data-pane="artists">Artists</div>
        <div class="tab" data-pane="about">About</div>
      </div>

      <div id="pane-mint" class="pane active">
        <div class="row">
          <select id="collectionSelect">
            <option value="boredapeyachtclub|0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d">BAYC</option>
            <option value="azuki|0xed5af388653567af2f388e6224dc7c4b3241c544">Azuki</option>
            <option value="doodles-official|0x8a90cab2b38dba80c64b7734e58ee1db38b8992e">Doodles</option>
            <!-- weitere ... -->
          </select>
          <input id="tokenIdInput" type="text" placeholder="Token ID" />
          <button id="loadBtn">Load NFT</button>
          <span id="nftBadge" class="badge">No NFT loaded</span>
        </div>

        <div class="row">
          <label>Mutation <input id="mutationRange" type="range" min="1" max="10" value="5"/></label>
          <label>Gene Flow <input id="flowRange" type="range" min="1" max="10" value="6"/></label>
        </div>

        <div class="row">
          <button id="generateBtn" disabled>Generate</button>
          <button id="mintBtn" disabled>Mint</button>
        </div>

        <canvas id="canvas" width="600" height="600"></canvas>
        <div id="statusText" class="status">Select a collection and enter a Token ID, then “Load NFT”.</div>
        <div class="footer">Chain: Base Sepolia (84532) • Contract: <span id="contractAddr">0xeA13E39C6fF7a70fC1Bd4F213D08BA395d336BCB</span></div>
      </div>

      <div id="pane-gallery" class="pane">
        <div class="coming"><b>Gallery</b><br/><i>Coming soon…</i></div>
      </div>
      <div id="pane-artists" class="pane">
        <div class="coming"><b>Artists</b><br/><i>Coming soon…</i></div>
      </div>
      <div id="pane-about" class="pane">
        <p><b>About N-Labs 95</b><br/>Hier kannst du noch ausführliche Beschreibung einfügen…</p>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";

/* CONFIG */
const CONTRACT_ADDRESS = "0xDEINE_NEUE_ADRESSE"; // <- Remix Deploy einsetzen
const BASE_SEPOLIA_CHAIN_ID = 84532;
const MINT_PRICE_ETH = "0.0";

/* ABI */
const ABI = [
  {
    "inputs": [
      { "internalType": "string",  "name": "tokenURI_",        "type": "string"  },
      { "internalType": "address", "name": "sourceCollection", "type": "address" },
      { "internalType": "uint256", "name": "sourceTokenId",    "type": "uint256" }
    ],
    "name": "mint",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "address", "name": "collection", "type": "address" },
      { "internalType": "uint256", "name": "tokenId",    "type": "uint256" }
    ],
    "name": "hasBeenUsed",
    "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs":[{ "internalType":"address", "name":"user", "type":"address" }],
    "name":"mintsLeft",
    "outputs":[{ "internalType":"uint256", "name":"", "type":"uint256" }],
    "stateMutability":"view",
    "type":"function"
  }
];

/* UI REFS */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d',{willReadFrequently:true});
const collectionSelect=document.getElementById('collectionSelect');
const tokenIdInput=document.getElementById('tokenIdInput');
const loadBtn=document.getElementById('loadBtn');
const generateBtn=document.getElementById('generateBtn');
const mintBtn=document.getElementById('mintBtn');
const statusText=document.getElementById('statusText');
const connectBtn=document.getElementById('connectBtn');
let provider, signer, nftImageData, currentSeed, lastLoadedKey, bgPastelHex="#eee";

/* WALLET */
async function ensureWallet(){
  if(!window.ethereum) throw new Error("Wallet not found");
  provider=new ethers.BrowserProvider(window.ethereum);
  signer=await provider.getSigner();
}
async function ensureBaseSepolia(){
  const net=await provider.getNetwork();
  if(Number(net.chainId)!==BASE_SEPOLIA_CHAIN_ID){
    await window.ethereum.request({method:"wallet_addEthereumChain",params:[{
      chainId:"0x14A34",chainName:"Base Sepolia",
      nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},
      rpcUrls:["https://sepolia.base.org"],
      blockExplorerUrls:["https://sepolia.basescan.org/"]
    }]});
  }
}
connectBtn.addEventListener('click',async()=>{
  try{
    await ensureWallet();await ensureBaseSepolia();
    connectBtn.textContent="✓";
    statusText.textContent=`Wallet: ${await signer.getAddress()}`;
  }catch(e){statusText.textContent="Connect failed";}
});

/* NFT Loader (verkürzt für Demo) */
function ipfsToHttp(u){return u?.startsWith("ipfs://")?"https://ipfs.io/ipfs/"+u.slice(7):u}
async function fetchNFTImage(contract,tokenId){
  try{
    const r=await fetch(`https://api.reservoir.tools/tokens/v7?tokens=${contract}:${tokenId}`);
    if(r.ok){const j=await r.json();return j?.tokens?.[0]?.token?.image;}
  }catch{} return null;
}
loadBtn.addEventListener('click',async()=>{
  const [slug,contract]=collectionSelect.value.split("|");
  const tokenId=tokenIdInput.value.trim();
  if(!tokenId){statusText.textContent="Token ID required";return;}
  const url=await fetchNFTImage(contract,tokenId);
  if(!url){statusText.textContent="NFT not found";return;}
  const img=new Image();img.crossOrigin="anonymous";
  img.onload=()=>{ctx.drawImage(img,0,0,600,600);nftImageData=ctx.getImageData(0,0,600,600);lastLoadedKey=`${slug}|${contract}|${tokenId}`;generateBtn.disabled=false;statusText.textContent=`Loaded ${slug} #${tokenId}`};
  img.src=ipfsToHttp(url);
});

/* Generate (dummy here) */
generateBtn.addEventListener('click',()=>{if(!nftImageData)return;ctx.fillStyle="#ddd";ctx.fillRect(0,0,600,600);currentSeed=Math.random();mintBtn.disabled=false;statusText.textContent="Generated."});

/* Mint */
mintBtn.addEventListener('click',async()=>{
  try{
    if(!signer) await ensureWallet();await ensureBaseSepolia();
    const contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
    const [slug,sourceCollection,sourceTokenIdStr]=lastLoadedKey.split("|");
    const sourceTokenId=BigInt(sourceTokenIdStr);

    // Checks
    const already=await contract.hasBeenUsed(sourceCollection,sourceTokenId);
    if(already){statusText.textContent="⚠️ Already minted.";return;}
    const left=await contract.mintsLeft(await signer.getAddress());
    if(Number(left)===0){statusText.textContent="⚠️ Wallet cap reached (3).";return;}

    const value=ethers.parseEther(MINT_PRICE_ETH);
    const tx=await contract.mint("ipfs://dummy",sourceCollection,sourceTokenId,{value});
    statusText.textContent=`Minting… ${tx.hash}`;
    await tx.wait();statusText.textContent=`✅ Minted! ${tx.hash}`;
  }catch(e){statusText.textContent="❌ "+(e?.message||e);}
});
</script>
</body>
</html>
