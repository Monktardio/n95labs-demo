<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NLABS — DNA Suite</title>
<style>
  :root{
    --win-blue:#000080; --chrome:#c0c0c0; --desk:#008080; --ink:#000;
  }
  body{ margin:0; background:var(--desk); font-family:"MS Sans Serif", Tahoma, Arial, sans-serif; }
  .app{ max-width:980px; margin:18px auto; background:var(--chrome); border:2px solid #fff; box-shadow:3px 3px 0 #000; }
  .title{ background:var(--win-blue); color:#fff; padding:6px 10px; font-weight:bold; display:flex; align-items:center; justify-content:space-between; }
  .tabs{ display:flex; gap:6px; padding:8px; border-bottom:2px inset #e5e5e5; background:#eaeaea;}
  .tab-btn{ background:#dcdcdc; border:2px outset #fff; padding:4px 10px; cursor:pointer; font-size:14px; }
  .tab-btn.active{ border:2px inset #fff; background:#efefef; }
  .pane{ display:none; padding:10px; background:#fff; border-top:0; }
  .pane.active{ display:block; }
  .window{ border:2px inset #c0c0c0; padding:10px; background:#fff; }

  /* Controls */
  .row{ display:grid; grid-template-columns: 1fr auto auto auto; gap:8px; align-items:center; }
  .row.slim{ grid-template-columns: 1fr 1fr 1fr 1fr; }
  .row.center{ grid-template-columns: auto auto 1fr auto; }
  .row > *{ min-width:0; }
  select,input[type=text]{ background:#fff; border:2px inset #fff; padding:4px; font-size:14px; }
  input[type=text]{ width:110px; }
  button{ padding:4px 10px; background:#c0c0c0; border:2px outset #fff; cursor:pointer; font-size:14px; }
  button:active{ border:2px inset #fff; }
  button:disabled{ color:#777; cursor:not-allowed; border:2px inset #fff; }
  label{ font-size:13px; white-space:nowrap; }
  input[type=range]{ width:100%; }
  .hint{ font-size:12px; color:var(--win-blue); margin:6px 0 8px; line-height:1.35; }
  .badge{ display:inline-block; font-size:12px; padding:2px 6px; background:#eee; border:1px solid #999; }
  .status{ font-size:13px; margin-top:8px; }
  canvas{ width:100%; max-width:600px; height:auto; border:2px solid #000; background:#eee; display:block; margin:8px auto 0; }

  /* Responsive */
  @media (max-width:720px){
    .row{ grid-template-columns: 1fr 1fr; }
    .row.slim{ grid-template-columns: 1fr 1fr; }
    .row.center{ grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="title">
    <div>NLABS — DNA Suite (Retro)</div>
    <div>☐ ✖</div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="about">About</button>
    <button class="tab-btn" data-tab="artists">Artists</button>
    <button class="tab-btn" data-tab="gallery">Gallery</button>
    <button class="tab-btn" data-tab="mint">Mint</button>
  </div>

  <!-- ABOUT -->
  <div id="about" class="pane active">
    <div class="window">
      <h3>What is the DNA Generator?</h3>
      <p>
        The DNA Generator grows abstract compositions from an NFT’s “genetic palette”.
        We extract dominant colors, set a pastel background that preserves the original hue,
        then flow geometric fragments along organic paths. Two knobs steer the system:
        <b>Mutation</b> (shape count & scale) and <b>Gene Flow</b> (path variety & curvature).
      </p>
      <p>
        This demo mints on <b>Sepolia</b>. Images and metadata are stored on-chain as a
        <code>data:application/json</code> tokenURI with a Base64-PNG image.
      </p>
    </div>
  </div>

  <!-- ARTISTS -->
  <div id="artists" class="pane">
    <div class="window">
      <h3>Artists @ NLABS</h3>
      <p>Showcase slot for creators (demo text). Curated capsules, interviews, and drop schedules will appear here.</p>
    </div>
  </div>

  <!-- GALLERY -->
  <div id="gallery" class="pane">
    <div class="window">
      <h3>Gallery</h3>
      <p>Curated demo pieces. (You can later render thumbnails from your mints or load sample JSON.)</p>
    </div>
  </div>

  <!-- MINT -->
  <div id="mint" class="pane">
    <div class="window">
      <!-- Row 1: Collection + ID + Load -->
      <div class="row" style="margin-bottom:8px">
        <select id="collectionSelect" title="Choose a collection">
          <option value="boredapeyachtclub|0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d">Bored Ape Yacht Club (BAYC)</option>
          <option value="mutant-ape-yacht-club|0x60e4d786628fea6478f785a6d7e704777c86a7c6">Mutant Ape Yacht Club (MAYC)</option>
          <option value="azuki|0xed5af388653567af2f388e6224dc7c4b3241c544">Azuki</option>
          <option value="doodles-official|0x8a90cab2b38dba80c64b7734e58ee1db38b8992e">Doodles</option>
          <option value="chimpers|0x80336ad7a747236ef41f47ed2c7641828a480baa">Chimpers</option>
          <option value="proof-moonbirds|0x23581767a106ae21c074b2276d25e5c3e136a68b">Moonbirds</option>
          <option value="pudgypenguins|0xbd3531da5cf5857e7cfaa92426877b022e612cf8">Pudgy Penguins</option>
          <option value="cryptopunks|0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb">CryptoPunks</option>
          <option value="mocaverse|0x59325733eb952a92e069c87f0a6168b29e80627f">Mocaverse</option>
          <option value="mfers|0x79fcdef22feed20eddacbb2587640e45491b757f">MFers</option>
        </select>
        <input id="tokenIdInput" type="text" placeholder="Token ID" />
        <button id="loadBtn">Load NFT</button>
        <span class="badge" id="nftBadge">No NFT loaded</span>
      </div>

      <!-- Row 2: Sliders -->
      <div class="row slim" style="margin-bottom:6px">
        <label>Mutation
          <input type="range" id="mutationRange" min="1" max="10" value="5"/>
        </label>
        <div></div>
        <label>Gene Flow
          <input type="range" id="flowRange" min="1" max="10" value="6"/>
        </label>
        <div></div>
      </div>

      <!-- Row 3: Generate / Mint -->
      <div class="row center" style="margin-bottom:6px">
        <div></div>
        <button id="generateBtn" disabled>Generate</button>
        <div></div>
        <button id="mintBtn" disabled>Mint</button>
      </div>

      <div class="hint">
        DNA Story: We read your NFT’s dominant colors, set a pastel background locked to its original hue,
        then grow layered geometric fragments along organic flow paths. Mutation controls fragment count/size;
        Gene Flow bends the paths.
      </div>

      <canvas id="canvas" width="600" height="600"></canvas>
      <div class="status" id="statusText">Select a collection + Token ID, then click “Load NFT”.</div>
    </div>
  </div>
</div>

<!-- Ethers.js for Sepolia mint -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>

<script>
/* ========= Tab wiring ========= */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

/* ========= Mint page logic (9.4/9.5 core) ========= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

const collectionSelect = document.getElementById('collectionSelect');
const tokenIdInput = document.getElementById('tokenIdInput');
const loadBtn = document.getElementById('loadBtn');
const generateBtn = document.getElementById('generateBtn');
const mintBtn = document.getElementById('mintBtn');
const mutationRange = document.getElementById('mutationRange');
const flowRange = document.getElementById('flowRange');
const statusText = document.getElementById('statusText');
const nftBadge = document.getElementById('nftBadge');

let nftImage = null;
let nftImageData = null;
let currentSeed = null;
let bgPastelHex = '#f8f8f8';
let lastLoadedKey = null;

/* ---------- Helpers ---------- */
function ipfsToHttp(url){ if(!url) return null; return url.startsWith('ipfs://') ? ('https://ipfs.io/ipfs/'+url.slice(7)) : url; }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
function rgbToHsl(r,g,b){ r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){ h=s=0; } else {
    const d=max-min;
    s=l>0.5? d/(2-max-min): d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      case b: h=(r-g)/d + 4; break;
    }
    h/=6;
  }
  return [h,s,l];
}
function hslToRgb(h,s,l){
  let r,g,b;
  if(s===0){ r=g=b=l; }
  else{
    const hue2rgb=(p,q,t)=>{ if(t<0)t+=1; if(t>1)t-=1;
      if(t<1/6) return p+(q-p)*6*t;
      if(t<1/2) return q;
      if(t<2/3) return p+(q-p)*(2/3-t)*6;
      return p;
    };
    const q=l<0.5? l*(1+s) : l+s-l*s;
    const p=2*l-q;
    r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);
  }
  return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];
}
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join(''); }

/* Dominant color with light quantization */
function dominantColorFromImage(img){
  const t=document.createElement('canvas'); t.width=64; t.height=64;
  const c=t.getContext('2d',{willReadFrequently:true});
  c.drawImage(img,0,0,64,64);
  const data=c.getImageData(0,0,64,64).data;
  const map=new Map(); const step=4*2;
  for(let i=0;i<data.length;i+=step){
    const a=data[i+3]; if(a<200) continue;
    const qr=(data[i]/16|0)*16, qg=(data[i+1]/16|0)*16, qb=(data[i+2]/16|0)*16;
    const key=`${qr},${qg},${qb}`;
    map.set(key,(map.get(key)||0)+1);
  }
  let best=null,count=-1;
  for(const [k,v] of map.entries()){ if(v>count){ best=k; count=v; } }
  if(!best) return {r:248,g:248,b:248};
  const [r,g,b]=best.split(',').map(n=>parseInt(n,10));
  return {r,g,b};
}

/* Pastelize while preserving hue (very light) */
function pastelizeFromRGB(r,g,b){
  let [h,s,l]=rgbToHsl(r,g,b);
  l = clamp(l + 0.10, 0, 1);   // +10% brightness
  s = clamp(Math.max(0, s - 0.06), 0, 1); // slightly less saturated
  const [R,G,B]=hslToRgb(h,s,l);
  return rgbToHex(R,G,B);
}

/* Character Priority palette */
function getCharacterPriorityColors(imageData, count=15){
  const colors={}; const d=imageData.data; const step=12;
  for(let i=0;i<d.length;i+=4*step){
    const r=d[i], g=d[i+1], b=d[i+2];
    const brightness=(r+g+b)/3;
    const saturation=Math.max(r,g,b)-Math.min(r,g,b);
    const key=`${r},${g},${b}`;
    const weight=(saturation*0.6)+(Math.abs(128-brightness)*0.2)+10;
    colors[key]=(colors[key]||0)+weight;
  }
  let sorted=Object.entries(colors).sort((a,b)=>b[1]-a[1]);
  const bg=sorted[0]?.[0]; sorted=sorted.filter(c=>c[0]!==bg);
  const pick=sorted.slice(0,count*3); const out=[]; let back=0;
  for(const [rgb,w] of pick){
    if(w<5) continue;
    if(back<2 && out.length<2){ out.push(`rgb(${rgb})`); back++; }
    else if(out.length<count){ out.push(`rgb(${rgb})`); }
  }
  return out.slice(0,count);
}

/* PRNG */
function mulberry32(seed){ return function(){ let t=seed+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }

/* Brush texture */
const brushPatterns=[];
function createBrushPatterns(context){
  brushPatterns.length=0;
  for(let i=0;i<3;i++){
    const b=document.createElement('canvas'); b.width=40; b.height=40;
    const bc=b.getContext('2d');
    bc.fillStyle=`rgba(0,0,0,${0.03+Math.random()*0.05})`;
    for(let j=0;j<50;j++){ bc.fillRect(Math.random()*40,Math.random()*40,1+Math.random()*2,1+Math.random()*2); }
    brushPatterns.push(context.createPattern(b,'repeat'));
  }
}

/* DNA compositor */
function chaosFragment(colors, mutation, flow, context, size, scale, rng){
  const big=mutation*2, mid=mutation*8, small=mutation*15;
  const paths=generateFlowPaths(flow,size,rng);
  drawShapes(paths,colors,big,80,140,context,scale,rng);
  drawShapes(paths,colors,mid,40,70,context,scale,rng);
  drawShapes(paths,colors,small,15,30,context,scale,rng);
  drawFlowLines(paths,context);
}
function generateFlowPaths(count,size,rng){
  const arr=[]; for(let i=0;i<count;i++){
    arr.push([{x:rng()*size,y:rng()*size},{x:rng()*size,y:rng()*size},{x:rng()*size,y:rng()*size}]);
  } return arr;
}
function bezierPoint(p0,p1,p2,t){
  return { x:(1-t)*(1-t)*p0.x + 2*(1-t)*t*p1.x + t*t*p2.x,
           y:(1-t)*(1-t)*p0.y + 2*(1-t)*t*p1.y + t*t*p2.y };
}
function drawShapes(paths, colors, count, minS, maxS, context, scale, rng){
  for(let i=0;i<count;i++){
    const path=paths[(rng()*paths.length)|0]; const t=rng(); const p=bezierPoint(path[0],path[1],path[2],t);
    const size=(minS + rng()*(maxS-minS))*scale;
    const c1=colors[(rng()*colors.length)|0], c2=colors[(rng()*colors.length)|0];
    drawShape(p.x,p.y,size,c1,c2,context,rng);
  }
}
function drawShape(x,y,size,c1,c2,context,rng){
  context.save(); context.translate(x,y); context.rotate(rng()*Math.PI);
  const g=context.createLinearGradient(-size/2,-size/2,size/2,size/2); g.addColorStop(0,c1); g.addColorStop(1,c2); context.fillStyle=g;
  context.shadowColor='rgba(0,0,0,0.15)'; context.shadowBlur=10*(size/100); context.shadowOffsetX=5*(size/150); context.shadowOffsetY=5*(size/150);
  const r=rng();
  if(r<0.2){ context.beginPath(); context.arc(0,0,size/2,0,Math.PI*2); context.fill(); }
  else if(r<0.4){ context.fillRect(-size/2,-size/2,size,size); }
  else if(r<0.6){ context.beginPath(); context.moveTo(-size/2,size/2); context.lineTo(size/2,size/2); context.lineTo(0,-size/2); context.closePath(); context.fill(); }
  else if(r<0.8){ context.beginPath(); for(let i=0;i<6;i++){ const a=(Math.PI/3)*i; context.lineTo((size/2)*Math.cos(a),(size/2)*Math.sin(a)); } context.closePath(); context.fill(); }
  else{ context.fillRect(-size/2,-size/4,size,size/2); }
  context.globalAlpha=0.8; context.fillStyle=brushPatterns[(rng()*brushPatterns.length)|0]; context.fillRect(-size/2,-size/2,size,size); context.globalAlpha=1;
  context.restore();
}
function drawFlowLines(paths,context){
  context.strokeStyle='rgba(0,0,0,0.12)'; context.lineWidth=1;
  for(const p of paths){ context.beginPath(); context.moveTo(p[0].x,p[0].y); context.quadraticCurveTo(p[1].x,p[1].y,p[2].x,p[2].y); context.stroke(); }
}
function addNoise(context,size){
  const d=context.getImageData(0,0,size,size);
  for(let i=0;i<d.data.length;i+=4){ const n=(Math.random()-0.5)*25; d.data[i]+=n; d.data[i+1]+=n; d.data[i+2]+=n; }
  context.putImageData(d,0,0);
}

/* ---------- Load NFT (Reservoir first, OpenSea fallback) ---------- */
async function fetchNFTImage(slug, contract, tokenId){
  try{
    const r=await fetch(`https://api.reservoir.tools/tokens/v7?tokens=${contract}:${tokenId}`);
    if(r.ok){ const j=await r.json(); const u=j?.tokens?.[0]?.token?.imageLarge || j?.tokens?.[0]?.token?.image; if(u) return ipfsToHttp(u); }
  }catch{}
  try{
    const r=await fetch(`https://api.opensea.io/api/v2/collection/${slug}/nfts/${tokenId}`);
    if(r.ok){ const j=await r.json(); const u=j?.nft?.image_original_url || j?.nft?.image_url; if(u) return ipfsToHttp(u); }
  }catch{}
  return null;
}

/* ---------- Local minted blocking (demo UX) ---------- */
function mintedKey(slug,tokenId){ return `minted:${slug}:${tokenId}`; }
function isMinted(slug,tokenId){ return localStorage.getItem(mintedKey(slug,tokenId))==='1'; }
function markMinted(slug,tokenId){ localStorage.setItem(mintedKey(slug,tokenId),'1'); }

/* ---------- UI wiring ---------- */
loadBtn.addEventListener('click', async ()=>{
  const [slug,contract] = collectionSelect.value.split('|');
  const tokenId = tokenIdInput.value.trim();
  if(!tokenId){ statusText.textContent='Please enter a Token ID.'; return; }
  if(isMinted(slug,tokenId)){ statusText.textContent='This Token ID is already minted locally. Pick another.'; return; }

  statusText.textContent='Loading NFT…'; nftBadge.textContent='Loading…'; generateBtn.disabled=true; mintBtn.disabled=true;

  const url = await fetchNFTImage(slug,contract,tokenId);
  if(!url){ statusText.textContent='NFT not found (or CORS). Try another ID.'; nftBadge.textContent='No NFT loaded'; return; }

  nftImage = new Image(); nftImage.crossOrigin='anonymous';
  nftImage.onload = ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const dom=dominantColorFromImage(nftImage); bgPastelHex=pastelizeFromRGB(dom.r,dom.g,dom.b);
    ctx.fillStyle=bgPastelHex; ctx.fillRect(0,0,canvas.width,canvas.height);
    // fit NFT
    const cw=canvas.width,ch=canvas.height, ir=nftImage.width/nftImage.height;
    let dw=cw, dh=cw/ir; if(dh>ch){ dh=ch; dw=dh*ir; }
    ctx.drawImage(nftImage,(cw-dw)/2,(ch-dh)/2,dw,dh);
    nftImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    statusText.textContent=`Loaded • ${slug} #${tokenId}`; nftBadge.textContent=`${slug} #${tokenId}`;
    generateBtn.disabled=false; mintBtn.disabled=true; lastLoadedKey=`${slug}|${contract}|${tokenId}`;
  };
  nftImage.onerror = ()=>{ statusText.textContent='Failed to load image.'; nftBadge.textContent='No NFT loaded'; };
  nftImage.src = url;
});

generateBtn.addEventListener('click', ()=>{
  if(!nftImageData){ alert('Load an NFT first.'); return; }
  ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle=bgPastelHex; ctx.fillRect(0,0,canvas.width,canvas.height);
  createBrushPatterns(ctx);
  const colors=getCharacterPriorityColors(nftImageData,15);
  const mutation=parseInt(mutationRange.value), flow=parseInt(flowRange.value);
  currentSeed=Math.floor(Math.random()*1e9); const rng=mulberry32(currentSeed);
  chaosFragment(colors,mutation,flow,ctx,600,1,rng); addNoise(ctx,600);
  statusText.textContent='Generated from NFT DNA — ready to Mint.'; mintBtn.disabled=false;
});

/* ========== Sepolia Mint integration ========== */
const SEP_CHAIN_ID_HEX = '0xaa36a7'; // 11155111
const CONTRACT_ADDRESS = '0x57e8279215E49b2168E312DE4347a40AaDCbf669';
const ABI = [
  "function mintOne(string calldata metadataURI) external payable",
  "function priceWei() view returns (uint256)",
  "function mintPaused() view returns (bool)",
  "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
];
let signer, contract;

async function ensureWallet(){
  if(!window.ethereum){ alert('Please install MetaMask.'); throw new Error('No wallet'); }
  const chainId = await window.ethereum.request({ method:'eth_chainId' });
  if(chainId !== SEP_CHAIN_ID_HEX){
    try{
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: SEP_CHAIN_ID_HEX }] });
    }catch(err){
      if(err.code === 4902){
        await window.ethereum.request({
          method:'wallet_addEthereumChain',
          params:[{ chainId: SEP_CHAIN_ID_HEX, chainName:'Sepolia',
            nativeCurrency:{ name:'SepoliaETH', symbol:'ETH', decimals:18 },
            rpcUrls:['https://sepolia.infura.io/v3/'],
            blockExplorerUrls:['https://sepolia.etherscan.io'] }]
        });
      } else { throw err; }
    }
  }
  const provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

/* Metadata (data: URL) */
function toBase64(str){ return btoa(unescape(encodeURIComponent(str))); }
function canvasToPng(){ return canvas.toDataURL('image/png'); }
function buildTraits(){
  const traits=[]; const [slug]= (collectionSelect.value||'').split('|');
  const tid=tokenIdInput.value.trim();
  traits.push({ trait_type:'Collection', value: slug||'unknown' });
  traits.push({ trait_type:'Token ID',  value: tid||'n/a' });
  traits.push({ trait_type:'Mutation',  value: parseInt(mutationRange.value) });
  traits.push({ trait_type:'Gene Flow', value: parseInt(flowRange.value) });
  if(typeof currentSeed==='number') traits.push({ trait_type:'Seed', value: currentSeed });
  traits.push({ trait_type:'Background', value: bgPastelHex });
  return traits;
}
function buildMetadataJSON(){
  const name = `NLABS DNA #${Date.now()}`;
  const description = "Procedural DNA artwork generated from an NFT’s color genome (NLABS 9.5). Demo mint on Sepolia.";
  return { name, description, image: canvasToPng(), attributes: buildTraits() };
}
function buildMetadataURI(){
  const json = JSON.stringify(buildMetadataJSON());
  return 'data:application/json;base64,' + toBase64(json);
}

mintBtn.addEventListener('click', async ()=>{
  try{
    if(!nftImage || !nftImageData){ alert('Please load an NFT and generate first.'); return; }
    await ensureWallet();

    // Contract state (optional)
    let valueWei = 0n;
    try{
      const paused = await contract.mintPaused(); if(paused){ alert('Mint is paused.'); return; }
      valueWei = await contract.priceWei();
    }catch{}

    const metadataURI = buildMetadataURI();
    statusText.textContent='Submitting mint transaction…';
    const tx = await contract.mintOne(metadataURI, { value: valueWei });
    statusText.textContent='Waiting for confirmation…';
    const receipt = await tx.wait();

    // tokenId aus Transfer-Event lesen
    let mintedTokenId=null;
    for(const log of receipt.logs){
      try{
        const parsed = contract.interface.parseLog(log);
        if(parsed?.name==='Transfer'){
          const to = parsed.args[1]; const tokenId = parsed.args[2];
          if(String(to).toLowerCase() === (await signer.getAddress()).toLowerCase()){
            mintedTokenId = tokenId.toString(); break;
          }
        }
      }catch{}
    }

    let links = `Tx: https://sepolia.etherscan.io/tx/${tx.hash}`;
    if(mintedTokenId){ links += `  |  Token: https://sepolia.etherscan.io/token/${CONTRACT_ADDRESS}?a=${mintedTokenId}`; }
    statusText.innerHTML = `Minted! ${links}`;
    alert('Mint successful! Links shown under the canvas.');

    // lokale Blockierung
    try{
      const [slug]=collectionSelect.value.split('|'); const tid=tokenIdInput.value.trim();
      localStorage.setItem(`minted:${slug}:${tid}`,'1');
    }catch{}

  }catch(err){
    console.error(err); alert(err.message || 'Mint failed.'); statusText.textContent='Mint failed. See console.';
  }
});

/* Initial canvas message */
(function boot(){
  ctx.fillStyle='#f8f8f8'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#000'; ctx.font='14px MS Sans Serif';
  ctx.fillText('Load an NFT, then Generate your DNA artwork.', 18, 28);
})();
</script>
</body>
</html>
