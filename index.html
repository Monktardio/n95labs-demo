<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mint — Mini App (Base)</title>
  <style>
    :root{ --bg:#008080; --panel:#c0c0c0; --blue:#000080; }
    html,body{margin:0;padding:0}
    body{background:var(--bg);font-family:'MS Sans Serif',Tahoma,Arial,sans-serif;min-height:100vh;display:grid;place-items:center}
    .win{width:min(720px,94vw);background:var(--panel);border:2px solid #fff;box-shadow:2px 2px 0 #000}
    .bar{background:var(--blue);color:#fff;padding:6px 10px;font-weight:bold;display:flex;align-items:center;justify-content:space-between}
    .content{padding:12px;background:#fff;border:2px inset #c0c0c0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
    label{font-size:14px}
    input,select{border:2px inset #fff;padding:6px;font-size:14px;background:#fff}
    input[type="text"], input[type="url"]{width:420px;max-width:100%}
    input[type="number"]{width:120px}
    button{padding:6px 12px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;font-size:14px}
    button:active{border:2px inset #fff}
    button:disabled{color:#777;cursor:not-allowed;border:2px inset #fff}
    .badge{background:#eee;border:1px solid #999;padding:4px 8px;font-size:12px}
    .status{font-size:12px;margin-top:8px;word-break:break-all}
    .hint{font-size:12px;color:#000080}
    .footer{margin-top:8px;font-size:11px;opacity:.9}
    .spacer{flex:1}

    /* === Canvas fix for mobile === */
    canvas {
      width: 100%;
      height: auto;
      max-width: 600px;
      display: block;
      margin: 8px auto;
      border: 2px solid #000;
      background: #eee;
    }
  </style>
</head>
<body>
  <div class="win">
    <div class="bar">
      <div>Mint — Mini App (Base)</div>
      <div class="row" style="margin:0">
        <span id="netBadge" class="badge">Not connected</span>
        <button id="connectBtn">Connect</button>
      </div>
    </div>
    <div class="content">
      <div class="row">
        <label>Contract</label>
        <input id="addressInput" type="text" placeholder="0x…" />
        <span class="badge" title="Target network">Base Mainnet (8453)</span>
      </div>

      <div class="row">
        <label>Token URI</label>
        <input id="uriInput" type="url" placeholder="ipfs://…/metadata.json" />
      </div>

      <div class="row">
        <label>Price (ETH)</label>
        <input id="priceInput" type="number" min="0" step="0.0001" value="0.0000" />
        <div class="spacer"></div>
        <button id="mintBtn" disabled>Mint</button>
      </div>

      <div class="hint">This minimal page calls <b>mint(string)</b> with a payable value. Switch the contract address and set price as needed. Network is auto-switched to <b>Base</b> (chainId 8453).</div>
      <div id="status" class="status">Ready.</div>
      <div class="footer">Tip: If your contract is on Base Sepolia, change the network constants in the script below.</div>

      <!-- Hier dein Canvas -->
      <canvas id="canvas" width="600" height="600"></canvas>
    </div>
  </div>

  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js';

    // ======= CONFIG =======
    const DEFAULT_CONTRACT = '0x21CFEFfe59d808d9a2D66f8e35bDDb125c491dd6'; // change if different on Base mainnet
    const TARGETS = {
      base: {
        chainIdDec: 8453,
        chainIdHex: '0x2105',
        chainName: 'Base',
        rpcUrls: ['https://mainnet.base.org'],
        blockExplorerUrls: ['https://basescan.org/'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }
      },
      baseSepolia: {
        chainIdDec: 84532,
        chainIdHex: '0x14A34',
        chainName: 'Base Sepolia',
        rpcUrls: ['https://sepolia.base.org'],
        blockExplorerUrls: ['https://sepolia.basescan.org/'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }
      }
    };

    // pick the network you want; default to Base mainnet
    const NET = TARGETS.base; // change to TARGETS.baseSepolia for testnet

    const ABI = [
      {
        inputs: [{ internalType: 'string', name: 'tokenURI_', type: 'string' }],
        name: 'mint',
        outputs: [],
        stateMutability: 'payable',
        type: 'function'
      }
    ];

    const addressInput = document.getElementById('addressInput');
    const uriInput = document.getElementById('uriInput');
    const priceInput = document.getElementById('priceInput');
    const mintBtn = document.getElementById('mintBtn');
    const connectBtn = document.getElementById('connectBtn');
    const statusEl = document.getElementById('status');
    const netBadge = document.getElementById('netBadge');

    addressInput.value = DEFAULT_CONTRACT;

    let provider, signer;

    function setStatus(msg){ statusEl.textContent = msg; }

    async function ensureWallet(){
      if (!window.ethereum) throw new Error('Wallet not found. Install MetaMask/Coinbase Wallet.');
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      return signer;
    }

    async function ensureNetwork(){
      const net = await provider.getNetwork();
      if (Number(net.chainId) !== NET.chainIdDec){
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: NET.chainIdHex,
            chainName: NET.chainName,
            nativeCurrency: NET.nativeCurrency,
            rpcUrls: NET.rpcUrls,
            blockExplorerUrls: NET.blockExplorerUrls
          }]
        });
      }
      const after = await provider.getNetwork();
      const label = `${NET.chainName} (${Number(after.chainId)})`;
      netBadge.textContent = label;
      netBadge.title = label;
    }

    connectBtn.addEventListener('click', async () => {
      try{
        await ensureWallet();
        await ensureNetwork();
        const addr = await signer.getAddress();
        setStatus(`Connected: ${addr}`);
        mintBtn.disabled = false;
        connectBtn.textContent = '✓ Connected';
      }catch(err){ setStatus('Connect failed: '+(err?.message||err)); }
    });

    mintBtn.addEventListener('click', async () => {
      try{
        if (!signer) await ensureWallet();
        await ensureNetwork();

        const contractAddress = addressInput.value.trim();
        if (!/^0x[0-9a-fA-F]{40}$/.test(contractAddress)) throw new Error('Invalid contract address');

        const tokenURI = uriInput.value.trim();
        if (!tokenURI) throw new Error('Token URI required (ipfs://…)');

        const valueEth = priceInput.value?.toString() || '0';
        const value = ethers.parseEther(valueEth);

        const contract = new ethers.Contract(contractAddress, ABI, signer);

        setStatus('Sending transaction…');
        const tx = await contract.mint(tokenURI, { value });
        setStatus(`Minting… Tx: ${tx.hash}`);
        const receipt = await tx.wait();

        // pick correct explorer
        const explorer = NET.blockExplorerUrls[0] || '';
        const link = explorer ? `${explorer.replace(/\/$/, '')}/tx/${tx.hash}` : '';
        setStatus(`✅ Minted in block ${receipt.blockNumber}. ${link ? 'View: '+link : ''}`);
      }catch(err){
        console.error(err);
        let msg = err?.info?.error?.message || err?.shortMessage || err?.message || String(err);
        setStatus('❌ Mint failed: '+ msg);
      }
    });

    function validate(){
      const ok = /^0x[0-9a-fA-F]{40}$/.test(addressInput.value.trim()) && !!uriInput.value.trim();
      mintBtn.disabled = !ok || !signer;
    }
    addressInput.addEventListener('input', validate);
    uriInput.addEventListener('input', validate);
    priceInput.addEventListener('input', validate);
  </script>
</body>
</html>
