<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NLABS — DNA Generator</title>
<style>
  /* Retro (Win95-ish) */
  body{background:#008080;margin:0;font-family:"MS Sans Serif",Tahoma,Arial,sans-serif}
  .app{max-width:900px;margin:14px auto;background:#c0c0c0;border:2px solid #fff;box-shadow:2px 2px 0 #000}
  .title{background:#000080;color:#fff;padding:4px 8px;font-weight:bold;display:flex;align-items:center;justify-content:space-between}
  .tabs{display:flex;gap:2px;background:#c0c0c0;padding:6px;border-top:2px inset #fff}
  .tab{padding:6px 10px;background:#e0e0e0;border:2px outset #fff;cursor:pointer;font-size:14px}
  .tab.active{background:#fff;border:2px inset #fff}
  .pane{display:none;background:#fff;border-top:2px inset #c0c0c0;padding:10px}
  .pane.active{display:block}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0}
  select,input[type=text]{background:#fff;border:2px inset #fff;padding:4px;font-size:14px}
  select{min-width:210px}
  input[type=text]{width:110px}
  button{padding:5px 10px;background:#c0c0c0;border:2px outset #fff;cursor:pointer;font-size:14px}
  button:active{border:2px inset #fff}
  button:disabled{color:#777;border:2px inset #fff;cursor:not-allowed}
  label{font-size:13px}
  input[type=range]{vertical-align:middle}
  canvas{width:100%;max-width:680px;height:auto;border:2px solid #000;background:#eee;display:block;margin-top:8px}
  .hint{font-size:12px;color:#000080;margin:6px 0}
  .status{font-size:12px;margin:6px 0}
  .badge{display:inline-block;background:#ececec;border:1px solid #999;padding:2px 6px;font-size:12px}
  /* Mobile: Stapeln und Buttons breit */
  @media (max-width:640px){
    .row{flex-direction:column;align-items:stretch}
    select, input[type=text], button{width:100%}
  }
  /* Simple "Coming Soon" card */
  .cs{background:#f4f4f4;border:2px dashed #aaa;padding:18px;margin:10px 0}
</style>
</head>
<body>
<div class="app">
  <div class="title">
    <div>NLABS — DNA Suite</div>
    <div style="display:flex;gap:6px"><div style="width:16px;height:16px;background:#c0c0c0;border:1px solid #fff"></div><div style="width:16px;height:16px;background:#c0c0c0;border:1px solid #fff"></div><div style="width:16px;height:16px;background:#c0c0c0;border:1px solid #fff"></div></div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="mint">Mint</div>
    <div class="tab" data-tab="gallery">Gallery</div>
    <div class="tab" data-tab="artists">Artists</div>
    <div class="tab" data-tab="about">About</div>
  </div>

  <!-- Mint -->
  <div class="pane active" id="pane-mint">
    <div class="row">
      <select id="collectionSelect" title="Choose a collection">
        <option value="boredapeyachtclub|0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d">Bored Ape Yacht Club (BAYC)</option>
        <option value="mutant-ape-yacht-club|0x60e4d786628fea6478f785a6d7e704777c86a7c6">Mutant Ape Yacht Club (MAYC)</option>
        <option value="azuki|0xed5af388653567af2f388e6224dc7c4b3241c544">Azuki</option>
        <option value="doodles-official|0x8a90cab2b38dba80c64b7734e58ee1db38b8992e">Doodles</option>
        <option value="chimpers|0x80336ad7a747236ef41f47ed2c7641828a480baa">Chimpers</option>
        <option value="proof-moonbirds|0x23581767a106ae21c074b2276d25e5c3e136a68b">Moonbirds</option>
        <option value="pudgypenguins|0xbd3531da5cf5857e7cfaa92426877b022e612cf8">Pudgy Penguins</option>
        <option value="cryptopunks|0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb">CryptoPunks</option>
        <option value="mocaverse|0x59325733eb952a92e069c87f0a6168b29e80627f">Mocaverse</option>
        <option value="mfers|0x79fcdef22feed20eddacbb2587640e45491b757f">MFers</option>
      </select>
      <input id="tokenIdInput" type="text" placeholder="Token ID" />
      <button id="loadBtn">Load NFT</button>
      <span class="badge" id="nftBadge">No NFT loaded</span>
    </div>

    <div class="row">
      <label>Mutation:
        <input type="range" id="mutationRange" min="1" max="10" value="5"/>
      </label>
      <label>Gene Flow:
        <input type="range" id="flowRange" min="1" max="10" value="6"/>
      </label>
      <button id="genBtn" disabled>Generate</button>
      <button id="mintBtn" disabled>Mint</button>
    </div>

    <div class="hint">
      We read your NFT’s “genetic palette”, set a subtle pastel background from that hue, then grow layered geometric fragments along organic flow paths. Mutation controls fragment count/size; Gene Flow bends the paths. Upload to IPFS starts automatically after Generate.
    </div>

    <canvas id="canvas" width="600" height="600"></canvas>
    <div class="status" id="status">Select a collection and Token ID, then “Load NFT”.</div>
  </div>

  <!-- Gallery -->
  <div class="pane" id="pane-gallery">
    <div class="cs">
      <b>Gallery — Coming Soon</b><br>
      Curated drops from NLABS artists in retro style. On-chain provenance, gas-optimized contracts, and DNA-based visuals.
    </div>
  </div>

  <!-- Artists -->
  <div class="pane" id="pane-artists">
    <div class="cs">
      <b>Artists — Coming Soon</b><br>
      Submit your portfolio, apply for spotlight features, and mint limited DNA editions.
    </div>
  </div>

  <!-- About -->
  <div class="pane" id="pane-about">
    <p><b>NLABS</b> is a retro-futuristic mini-app for generative art. The DNA Engine extracts a palette from your NFT, composes layered fragments along smooth flow fields, and mints the result as a collectible.</p>
    <p>Demo: Sepolia testnet, IPFS via web3.storage. Production: Base L2 with Coinbase Wallet support.</p>
  </div>
</div>

<script>
/* ---------- Tabs ---------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('pane-'+t.dataset.tab).classList.add('active');
  });
});

/* ---------- UI refs ---------- */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently:true });
const collectionSelect = document.getElementById('collectionSelect');
const tokenIdInput = document.getElementById('tokenIdInput');
const loadBtn = document.getElementById('loadBtn');
const genBtn = document.getElementById('genBtn');
const mintBtn = document.getElementById('mintBtn');
const mutationRange = document.getElementById('mutationRange');
const flowRange = document.getElementById('flowRange');
const statusEl = document.getElementById('status');
const nftBadge = document.getElementById('nftBadge');

/* ---------- State ---------- */
let nftImage=null, nftImageData=null, currentSeed=null, bgPastelHex='#f8f8f8';
let lastLoadedKey=null; // slug|contract|id
let lastTokenURI=null;  // wird nach Auto-Upload gesetzt

/* ---------- Helpers ---------- */
function ipfsToHttp(u){ if(!u) return null; return u.startsWith('ipfs://') ? 'https://ipfs.io/ipfs/'+u.slice(7) : u; }
function clamp(v,min,max){return Math.min(max,Math.max(min,v));}

function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=s=0;}else{const d=max-min;s=l>0.5? d/(2-max-min): d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return[h,s,l]}
function hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<0.5? l*(1+s): l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)]}
function rgbToHex(r,g,b){return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')}

function dominantColorFromImage(img){
  const t=document.createElement('canvas');const s=64;t.width=s;t.height=s;
  const c=t.getContext('2d',{willReadFrequently:true});c.drawImage(img,0,0,s,s);
  const d=c.getImageData(0,0,s,s).data;const map=new Map();const step=4*2;
  for(let i=0;i<d.length;i+=step){const r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];if(a<200) continue;
    const qr=(r/16|0)*16,qg=(g/16|0)*16,qb=(b/16|0)*16;const k=`${qr},${qg},${qb}`;
    map.set(k,(map.get(k)||0)+1);}
  let best=null,bc=-1;for(const [k,v] of map.entries()){if(v>bc){best=k;bc=v}}
  if(!best) return {r:248,g:248,b:248};const [r,g,b]=best.split(',').map(n=>parseInt(n,10));return {r,g,b};
}
function pastelizeFromRGB(r,g,b){
  let [h,s,l]=rgbToHsl(r,g,b); l=clamp(l+0.08,0,1); s=clamp(s-0.05,0,1);
  const [R,G,B]=hslToRgb(h,s,l); return rgbToHex(R,G,B);
}

/* Character Priority 2.0 */
function getCharacterPriorityColors(imageData,count=15){
  const colors={}, step=12, d=imageData.data;
  for(let i=0;i<d.length;i+=4*step){const r=d[i],g=d[i+1],b=d[i+2];
    const bright=(r+g+b)/3, sat=Math.max(r,g,b)-Math.min(r,g,b);
    const k=`${r},${g},${b}`; colors[k]=(colors[k]||0) + (sat*0.6)+ (Math.abs(128-bright)*0.2)+10;}
  let sorted=Object.entries(colors).sort((a,b)=>b[1]-a[1]);const bg=sorted[0]?.[0];
  sorted = sorted.filter(c=>c[0]!==bg); const top=sorted.slice(0,count*3);
  const out=[]; let bgshare=0; for(const [rgb,w] of top){ if(w<5) continue;
    if(bgshare<2 && out.length<2){out.push(`rgb(${rgb})`);bgshare++;} else if(out.length<count) out.push(`rgb(${rgb})`);}
  return out.slice(0,count);
}

/* PRNG */
function mulberry32(seed){return function(){let t=seed+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}

/* Brushes + DNA draw */
const brushPatterns=[];
function createBrushPatterns(context){
  brushPatterns.length=0; for(let i=0;i<3;i++){const b=document.createElement('canvas');b.width=40;b.height=40;
    const bc=b.getContext('2d');bc.fillStyle=`rgba(0,0,0,${0.03+Math.random()*0.05})`;
    for(let j=0;j<50;j++){bc.fillRect(Math.random()*40,Math.random()*40,1+Math.random()*2,1+Math.random()*2)}
    brushPatterns.push(context.createPattern(b,'repeat')); }
}
function chaosFragment(colors,mutation,flow,context,size,scale,rng){
  const big=mutation*2, mid=mutation*8, small=mutation*15;
  const paths=generateFlowPaths(flow,size,rng);
  drawShapes(paths,colors,big,80,140,context,scale,rng);
  drawShapes(paths,colors,mid,40,70,context,scale,rng);
  drawShapes(paths,colors,small,15,30,context,scale,rng);
  drawFlowLines(paths,context);
}
function generateFlowPaths(count,size,rng){const arr=[];for(let i=0;i<count;i++){arr.push([{x:rng()*size,y:rng()*size},{x:rng()*size,y:rng()*size},{x:rng()*size,y:rng()*size}])}return arr}
function bezierPoint(p0,p1,p2,t){return{x:(1-t)*(1-t)*p0.x+2*(1-t)*t*p1.x+t*t*p2.x,y:(1-t)*(1-t)*p0.y+2*(1-t)*t*p1.y+t*t*p2.y}}
function drawShapes(paths,colors,count,minS,maxS,ctx,scale,rng){
  for(let i=0;i<count;i++){const path=paths[(rng()*paths.length)|0], t=rng(), p=bezierPoint(path[0],path[1],path[2],t);
    const size=(minS + rng()*(maxS-minS))*scale; const c1=colors[(rng()*colors.length)|0], c2=colors[(rng()*colors.length)|0]; drawShape(p.x,p.y,size,c1,c2,ctx,rng)}
}
function drawShape(x,y,size,c1,c2,ctx,rng){
  ctx.save(); ctx.translate(x,y); ctx.rotate(rng()*Math.PI);
  const g=ctx.createLinearGradient(-size/2,-size/2,size/2,size/2); g.addColorStop(0,c1); g.addColorStop(1,c2); ctx.fillStyle=g;
  ctx.shadowColor='rgba(0,0,0,0.15)'; ctx.shadowBlur=10*(size/100); ctx.shadowOffsetX=5*(size/150); ctx.shadowOffsetY=5*(size/150);
  const r=rng(); if(r<0.2){ctx.beginPath();ctx.arc(0,0,size/2,0,Math.PI*2);ctx.fill();}
  else if(r<0.4){ctx.fillRect(-size/2,-size/2,size,size);}
  else if(r<0.6){ctx.beginPath();ctx.moveTo(-size/2,size/2);ctx.lineTo(size/2,size/2);ctx.lineTo(0,-size/2);ctx.closePath();ctx.fill();}
  else if(r<0.8){ctx.beginPath();for(let i=0;i<6;i++){const a=(Math.PI/3)*i;ctx.lineTo((size/2)*Math.cos(a),(size/2)*Math.sin(a))}ctx.closePath();ctx.fill();}
  else{ctx.fillRect(-size/2,-size/4,size,size/2);}
  ctx.globalAlpha=0.8; ctx.fillStyle=brushPatterns[(rng()*brushPatterns.length)|0]; ctx.fillRect(-size/2,-size/2,size,size); ctx.globalAlpha=1;
  ctx.restore();
}
function drawFlowLines(paths,ctx){ctx.strokeStyle='rgba(0,0,0,0.12)';ctx.lineWidth=1;paths.forEach(p=>{ctx.beginPath();ctx.moveTo(p[0].x,p[0].y);ctx.quadraticCurveTo(p[1].x,p[1].y,p[2].x,p[2].y);ctx.stroke();})}
function addNoise(ctx,size){const d=ctx.getImageData(0,0,size,size);for(let i=0;i<d.data.length;i+=4){const n=(Math.random()-0.5)*25;d.data[i]+=n;d.data[i+1]+=n;d.data[i+2]+=n}ctx.putImageData(d,0,0)}

/* ---------- Data sources ---------- */
async function fetchNFTImage(slug, contract, tokenId){
  try{
    const r=await fetch(`https://api.reservoir.tools/tokens/v7?tokens=${contract}:${tokenId}`);
    if(r.ok){const j=await r.json(); const u=j?.tokens?.[0]?.token?.imageLarge || j?.tokens?.[0]?.token?.image; if(u) return ipfsToHttp(u);}
  }catch(e){}
  try{
    const r=await fetch(`https://api.opensea.io/api/v2/collection/${slug}/nfts/${tokenId}`);
    if(r.ok){const j=await r.json(); const u=j?.nft?.image_original_url || j?.nft?.image_url; if(u) return ipfsToHttp(u);}
  }catch(e){}
  return null;
}

/* ---------- Load NFT ---------- */
loadBtn.addEventListener('click', async ()=>{
  const [slug,contract]=collectionSelect.value.split('|'); const id=tokenIdInput.value.trim();
  if(!id){statusEl.textContent='Enter a Token ID.'; return;}
  statusEl.textContent='Loading NFT…'; genBtn.disabled=true; mintBtn.disabled=true; lastTokenURI=null;

  const url=await fetchNFTImage(slug,contract,id);
  if(!url){statusEl.textContent='NFT not found (or CORS blocked). Try a different ID.'; return;}

  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{
    nftImage=img; ctx.clearRect(0,0,canvas.width,canvas.height);
    const dom=dominantColorFromImage(img); bgPastelHex=pastelizeFromRGB(dom.r,dom.g,dom.b);
    ctx.fillStyle=bgPastelHex; ctx.fillRect(0,0,canvas.width,canvas.height);
    const cw=canvas.width,ch=canvas.height, ir=img.width/img.height; let dw=cw,dh=cw/ir; if(dh>ch){dh=ch;dw=dh*ir}
    ctx.drawImage(img,(cw-dw)/2,(ch-dh)/2,dw,dh);
    nftImageData=ctx.getImageData(0,0,cw,ch);
    nftBadge.textContent=`${slug} #${id}`; statusEl.textContent='NFT loaded — ready to Generate.'; genBtn.disabled=false;
  };
  img.onerror=()=>{statusEl.textContent='Failed to load image.';}
  img.src=url;
});

/* ---------- Generate + Auto-Upload ---------- */
genBtn.addEventListener('click', async ()=>{
  if(!nftImageData){alert('Load an NFT first.');return;}
  // render preview
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=bgPastelHex; ctx.fillRect(0,0,canvas.width,canvas.height);
  createBrushPatterns(ctx);
  const colors=getCharacterPriorityColors(nftImageData,15);
  const mutation=parseInt(mutationRange.value,10);
  const flow=parseInt(flowRange.value,10);
  currentSeed=Math.floor(Math.random()*1e9); const rng=mulberry32(currentSeed);
  chaosFragment(colors,mutation,flow,ctx,600,1,rng); addNoise(ctx,600);
  statusEl.textContent='Art generated — uploading to IPFS…'; mintBtn.disabled=true;

  // HIGH-RES → adaptive compression + auto upload
  try{
    const tokenURI = await autoUploadHighRes();
    lastTokenURI = tokenURI;
    statusEl.textContent='Uploaded to IPFS — ready to Mint.';
    mintBtn.disabled=false;
  }catch(e){
    console.error(e);
    statusEl.textContent='Upload failed. Try lower Mutation or try again.';
    mintBtn.disabled=true;
  }
});

/* Adaptiv: verkleinert Größe/Qualität, bis < ~4 MB */
async function autoUploadHighRes(){
  // vorher: const targetMaxMB = 3.8;
  const targetMaxMB = 2.2; // <= kleineres Ziel, damit Base64 unter Vercel-Limit bleibt
  let sizePx = 1500;       // vorher 1600 – leicht senken
  let quality = 0.82;      // vorher 0.85 – leicht senken

  while(true){
    const t=document.createElement('canvas'); 
    t.width=sizePx; t.height=sizePx;
    const tc=t.getContext('2d');

    // Render identisch zur Preview (gleiches Seed!)
    tc.fillStyle=bgPastelHex; 
    tc.fillRect(0,0,sizePx,sizePx);
    createBrushPatterns(tc);
    const colors=getCharacterPriorityColors(nftImageData,15);
    const mutation=parseInt(mutationRange.value,10);
    const flow=parseInt(flowRange.value,10);
    const rng=mulberry32(currentSeed);
    chaosFragment(colors,mutation,flow,tc,sizePx,sizePx/600,rng);
    addNoise(tc,sizePx);

    const dataURL = t.toDataURL('image/jpeg', quality);
    const blob = await (await fetch(dataURL)).blob();
    const mb = blob.size/1024/1024;

    if(mb <= targetMaxMB || (sizePx<=1000 && quality<=0.70)){
      const [slug] = collectionSelect.value.split('|');
      const id = tokenIdInput.value.trim();
      const name = `NLABS DNA — ${slug} #${id}`;
      const description = `DNA artwork generated from ${slug} #${id}.`;

      const resp = await fetch('/api/upload', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ imageDataURL:dataURL, name, description })
      });

      if(!resp.ok){
        const txt = await resp.text();
        throw new Error(`Upload error ${resp.status}: ${txt}`);
      }
      const { tokenURI } = await resp.json();
      return tokenURI;
    }

    // aggressiver verkleinern
    if(quality > 0.74){ 
      quality -= 0.05;            // 0.82 -> 0.77 -> 0.72
    } else {
      sizePx -= 150;              // 1500 -> 1350 -> 1200 -> …
    }
  }
}


/* ---------- Mint (Demo/Hook) ---------- */
mintBtn.addEventListener('click', async ()=>{
  if(!lastTokenURI){alert('Generate first.'); return;}
  // Hier rufst du deinen Contract auf, z. B.:
  // const tx = await contract.mintOne(lastTokenURI, { value: ... });
  // await tx.wait();
  alert(`Would mint with tokenURI:\n${lastTokenURI}\n(Integrate your contract call here)`);
});

/* Boot screen */
(function(){ctx.fillStyle='#f8f8f8';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#000';ctx.font='14px MS Sans Serif';ctx.fillText('Load an NFT, then Generate your DNA artwork.',18,28)})();
</script>
</body>
</html>
